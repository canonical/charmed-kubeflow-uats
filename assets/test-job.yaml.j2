apiVersion: batch/v1
kind: Job
metadata:
  name: {{ job_name }}
spec:
  backoffLimit: 0
  template:
    metadata:
      annotations:
        # Ensures istio-proxy container terminates when the Job finishes (sidecar)
        # and is safely ignored in ambient mode.
        sidecar.istio.io/nativeSidecar: "true"
      labels:
          {% if proxy %}
          notebook-proxy: "true"
          {% endif %}
          {% if security_policy %}
          security-policy: "true"
          {% endif %}
          access-feast: "true"
          access-minio: "true"
          access-ml-pipeline: "true"
          mlflow-server-minio: "true"
          access-spark-notebook: "true"
    spec:
      {% if not tests_local_run %}
      # securityContext is needed in order for test files to be writeable 
      # since the tests save the notebooks. Setting it enables:
      # * The test-volume to be group-owned by this GID.
      # * The GID to be added to each container.
      securityContext:
        fsGroup: 101
      {% else %}
      # needed for exemptions from the Pod Security Admission Controller in
      # order to be able to mount Volumes via "hostPath" despite possible
      # "baseline" Pod Security Standards
      runtimeClassName: uats
      {% endif %}
      serviceAccountName: default-editor
      containers:
        - name: {{ job_name }}
          image: {{ tests_image }}
          command:
            - bash
            - -c
          args:
            - |
              {% if tests_local_run %}
              cd /tests;
              {% else %}
              cd /tests/charmed-kubeflow-uats/tests;
              {% endif %}
              python3 -m pip install -r requirements.txt >/dev/null;
              {{ pytest_cmd }}
          volumeMounts:
            - name: test-volume
              mountPath: /tests
      {% if not tests_local_run %}
      initContainers:
        - name: git-sync
          # This container pulls git data and publishes it into volume
          # "test-volume".
          image: registry.k8s.io/git-sync/git-sync:v4.0.0
          args:
            - --repo=https://github.com/canonical/charmed-kubeflow-uats
            - --ref={{ tests_remote_commit }}
            - --root=/tests
            - --group-write
            - --one-time
          volumeMounts:
            - name: test-volume
              mountPath: /tests
      {% endif %}
      volumes:
        - name: test-volume
          {% if tests_local_run %}
          hostPath:
            path: {{ tests_local_dir }}
          {% else %}
          emptyDir: {}
          {% endif %}
      restartPolicy: Never
